import React, { useState, useEffect, useRef, useCallback } from 'react';
import { 
  Ear, 
  Play, 
  Pause, 
  Square, 
  Volume2, 
  VolumeX, 
  Settings,
  Mic,
  MicOff,
  Languages,
  Users,
  Activity,
  Zap,
  ZapOff,
  Filter,
  FilterX,
  BarChart3,
  Clock,
  AlertTriangle,
  CheckCircle,
  Radio,
  Waves,
  Target,
  Eye,
  EyeOff
} from 'lucide-react';
import { Button } from '@/components/ui/button.jsx';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '@/components/ui/card.jsx';
import { Badge } from '@/components/ui/badge.jsx';
import { Progress } from '@/components/ui/progress.jsx';
import { Slider } from '@/components/ui/slider.jsx';
import { Switch } from '@/components/ui/switch.jsx';
import { Tabs, TabsContent, TabsList, TabsTrigger } from '@/components/ui/tabs.jsx';

const ExternalAudioTranslator = ({ 
  className = '',
  onTranslationUpdate = () => {},
  defaultSourceLanguage = 'auto',
  defaultTargetLanguage = 'en-US'
}) => {
  // Áä∂ÊÄÅÁÆ°ÁêÜ
  const [isListening, setIsListening] = useState(false);
  const [isProcessing, setIsProcessing] = useState(false);
  const [sourceLanguage, setSourceLanguage] = useState(defaultSourceLanguage);
  const [targetLanguage, setTargetLanguage] = useState(defaultTargetLanguage);
  const [sensitivity, setSensitivity] = useState(0.5);
  const [noiseReduction, setNoiseReduction] = useState(true);
  const [autoTranslate, setAutoTranslate] = useState(true);
  const [continuousMode, setContinuousMode] = useState(true);
  const [volume, setVolume] = useState(0.8);
  const [sessionId, setSessionId] = useState(null);
  const [currentText, setCurrentText] = useState('');
  const [translatedText, setTranslatedText] = useState('');
  const [audioLevel, setAudioLevel] = useState(0);
  const [backgroundNoise, setBackgroundNoise] = useState(0);
  const [detectedSpeakers, setDetectedSpeakers] = useState([]);
  const [translationHistory, setTranslationHistory] = useState([]);
  const [audioQuality, setAudioQuality] = useState('good');
  const [processingTime, setProcessingTime] = useState(0);
  const [translationCount, setTranslationCount] = useState(0);
  const [listeningDuration, setListeningDuration] = useState(0);
  const [voiceActivity, setVoiceActivity] = useState(false);
  const [showAdvanced, setShowAdvanced] = useState(false);

  // Refs
  const mediaStreamRef = useRef(null);
  const audioContextRef = useRef(null);
  const analyserRef = useRef(null);
  const mediaRecorderRef = useRef(null);
  const audioChunksRef = useRef([]);
  const intervalRef = useRef(null);
  const durationTimerRef = useRef(null);
  const sessionRef = useRef(null);

  // ÊîØÊåÅÁöÑËØ≠Ë®ÄÂàóË°®
  const supportedLanguages = [
    { code: 'auto', name: 'Ëá™Âä®Ê£ÄÊµã', flag: 'üåê' },
    { code: 'zh-CN', name: '‰∏≠Êñá(ÁÆÄ‰Ωì)', flag: 'üá®üá≥' },
    { code: 'en-US', name: 'English', flag: 'üá∫üá∏' },
    { code: 'ja-JP', name: 'Êó•Êú¨Ë™û', flag: 'üáØüáµ' },
    { code: 'ko-KR', name: 'ÌïúÍµ≠Ïñ¥', flag: 'üá∞üá∑' },
    { code: 'fr-FR', name: 'Fran√ßais', flag: 'üá´üá∑' },
    { code: 'de-DE', name: 'Deutsch', flag: 'üá©üá™' },
    { code: 'es-ES', name: 'Espa√±ol', flag: 'üá™üá∏' },
    { code: 'it-IT', name: 'Italiano', flag: 'üáÆüáπ' },
    { code: 'pt-PT', name: 'Portugu√™s', flag: 'üáµüáπ' },
    { code: 'ru-RU', name: '–†—É—Å—Å–∫–∏–π', flag: 'üá∑üá∫' },
    { code: 'ar-SA', name: 'ÿßŸÑÿπÿ±ÿ®Ÿäÿ©', flag: 'üá∏üá¶' },
    { code: 'hi-IN', name: '‡§π‡§ø‡§®‡•ç‡§¶‡•Ä', flag: 'üáÆüá≥' }
  ];

  // ÂàùÂßãÂåñÈü≥È¢ë‰∏ä‰∏ãÊñá
  useEffect(() => {
    const initAudioContext = async () => {
      try {
        audioContextRef.current = new (window.AudioContext || window.webkitAudioContext)();
        analyserRef.current = audioContextRef.current.createAnalyser();
        analyserRef.current.fftSize = 512;
      } catch (error) {
        console.error('Èü≥È¢ë‰∏ä‰∏ãÊñáÂàùÂßãÂåñÂ§±Ë¥•:', error);
      }
    };

    initAudioContext();

    return () => {
      if (audioContextRef.current) {
        audioContextRef.current.close();
      }
      if (intervalRef.current) {
        clearInterval(intervalRef.current);
      }
      if (durationTimerRef.current) {
        clearInterval(durationTimerRef.current);
      }
    };
  }, []);

  // ÁîüÊàê‰ºöËØùID
  const generateSessionId = () => {
    return 'external_audio_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
  };

  // Ëé∑ÂèñÈ∫¶ÂÖãÈ£éÊùÉÈôê
  const getMicrophoneStream = async () => {
    try {
      const stream = await navigator.mediaDevices.getUserMedia({
        audio: {
          echoCancellation: noiseReduction,
          noiseSuppression: noiseReduction,
          autoGainControl: true,
          sampleRate: 44100,
          channelCount: 1
        }
      });

      return stream;
    } catch (error) {
      console.error('Ëé∑ÂèñÈ∫¶ÂÖãÈ£éÂ§±Ë¥•:', error);
      throw new Error('Êó†Ê≥ïËé∑ÂèñÈ∫¶ÂÖãÈ£éÊùÉÈôêÔºåËØ∑Ê£ÄÊü•ËÆæÁΩÆ');
    }
  };

  // ËÆæÁΩÆÈü≥È¢ëÂàÜÊûêÂô®
  const setupAudioAnalyser = (stream) => {
    if (!audioContextRef.current || !analyserRef.current) return;

    const source = audioContextRef.current.createMediaStreamSource(stream);
    source.connect(analyserRef.current);

    // ÂºÄÂßãÈü≥È¢ëÁ∫ßÂà´ÁõëÊéß
    const updateAudioLevel = () => {
      const dataArray = new Uint8Array(analyserRef.current.frequencyBinCount);
      analyserRef.current.getByteFrequencyData(dataArray);
      
      const average = dataArray.reduce((sum, value) => sum + value, 0) / dataArray.length;
      const normalizedLevel = average / 255;
      
      setAudioLevel(normalizedLevel);
      
      // Ê£ÄÊµãËØ≠Èü≥Ê¥ªÂä®
      const voiceThreshold = sensitivity * 0.1;
      const hasVoice = normalizedLevel > voiceThreshold;
      setVoiceActivity(hasVoice);
      
      // Êõ¥Êñ∞ËÉåÊôØÂô™Èü≥Á∫ßÂà´
      if (!hasVoice) {
        setBackgroundNoise(prev => prev * 0.9 + normalizedLevel * 0.1);
      }
    };

    intervalRef.current = setInterval(updateAudioLevel, 100);
  };

  // ÂêØÂä®Â§ñÈÉ®Èü≥È¢ëÁõëÂê¨
  const startListening = async () => {
    try {
      setIsProcessing(true);
      
      // Ëé∑ÂèñÈ∫¶ÂÖãÈ£éÊµÅ
      const stream = await getMicrophoneStream();
      mediaStreamRef.current = stream;
      setupAudioAnalyser(stream);

      // ËÆæÁΩÆÂ™í‰ΩìÂΩïÂà∂Âô®
      mediaRecorderRef.current = new MediaRecorder(stream, {
        mimeType: 'audio/webm;codecs=opus'
      });

      audioChunksRef.current = [];

      mediaRecorderRef.current.ondataavailable = (event) => {
        if (event.data.size > 0) {
          audioChunksRef.current.push(event.data);
        }
      };

      mediaRecorderRef.current.onstop = async () => {
        if (audioChunksRef.current.length > 0) {
          const audioBlob = new Blob(audioChunksRef.current, { type: 'audio/webm' });
          await processAudioBlob(audioBlob);
          audioChunksRef.current = [];
        }
      };

      // ÁîüÊàêÊñ∞ÁöÑ‰ºöËØùID
      const newSessionId = generateSessionId();
      setSessionId(newSessionId);
      sessionRef.current = newSessionId;

      // ÂêØÂä®ÂêéÁ´ØÁõëÂê¨
      await startBackendListening(newSessionId);

      // ÂºÄÂßãÂΩïÂà∂
      if (continuousMode) {
        mediaRecorderRef.current.start(3000); // ÊØè3ÁßíÂ§ÑÁêÜ‰∏ÄÊ¨°
      }

      // ÂºÄÂßãËÆ°Êó∂
      durationTimerRef.current = setInterval(() => {
        setListeningDuration(prev => prev + 1);
      }, 1000);

      setIsListening(true);
      setIsProcessing(false);

    } catch (error) {
      console.error('ÂêØÂä®Â§ñÈÉ®Èü≥È¢ëÁõëÂê¨Â§±Ë¥•:', error);
      setIsProcessing(false);
      alert(error.message);
    }
  };

  // ÂÅúÊ≠¢Â§ñÈÉ®Èü≥È¢ëÁõëÂê¨
  const stopListening = async () => {
    try {
      setIsProcessing(true);

      if (mediaRecorderRef.current && mediaRecorderRef.current.state !== 'inactive') {
        mediaRecorderRef.current.stop();
      }

      if (mediaStreamRef.current) {
        mediaStreamRef.current.getTracks().forEach(track => track.stop());
        mediaStreamRef.current = null;
      }

      if (intervalRef.current) {
        clearInterval(intervalRef.current);
        intervalRef.current = null;
      }

      if (durationTimerRef.current) {
        clearInterval(durationTimerRef.current);
        durationTimerRef.current = null;
      }

      if (sessionRef.current) {
        await stopBackendListening(sessionRef.current);
      }

      setIsListening(false);
      setIsProcessing(false);
      setAudioLevel(0);
      setVoiceActivity(false);
      setSessionId(null);
      sessionRef.current = null;
      setListeningDuration(0);

    } catch (error) {
      console.error('ÂÅúÊ≠¢Â§ñÈÉ®Èü≥È¢ëÁõëÂê¨Â§±Ë¥•:', error);
      setIsProcessing(false);
    }
  };

  // ÂêØÂä®ÂêéÁ´ØÁõëÂê¨
  const startBackendListening = async (sessionId) => {
    try {
      const response = await fetch('/api/external-audio/start-listening', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          sessionId,
          sourceLanguage,
          targetLanguage,
          sensitivity,
          noiseReduction,
          autoTranslate,
          continuousMode,
          maxDuration: 1800000 // 30ÂàÜÈíü
        })
      });

      const data = await response.json();
      if (!data.success) {
        throw new Error(data.error);
      }

    } catch (error) {
      console.error('ÂêØÂä®ÂêéÁ´ØÁõëÂê¨Â§±Ë¥•:', error);
      throw error;
    }
  };

  // ÂÅúÊ≠¢ÂêéÁ´ØÁõëÂê¨
  const stopBackendListening = async (sessionId) => {
    try {
      const response = await fetch('/api/external-audio/stop-listening', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ sessionId })
      });

      const data = await response.json();
      if (data.success && data.data.stats) {
        setTranslationCount(data.data.stats.translationCount);
      }

    } catch (error) {
      console.error('ÂÅúÊ≠¢ÂêéÁ´ØÁõëÂê¨Â§±Ë¥•:', error);
    }
  };

  // Â§ÑÁêÜÈü≥È¢ëÊï∞ÊçÆ
  const processAudioBlob = async (audioBlob) => {
    if (!autoTranslate || !sessionRef.current) return;

    try {
      const startTime = Date.now();

      const formData = new FormData();
      formData.append('audio', audioBlob, 'audio.webm');
      formData.append('sessionId', sessionRef.current);
      formData.append('sourceLanguage', sourceLanguage);
      formData.append('targetLanguage', targetLanguage);
      formData.append('enhanceAudio', noiseReduction.toString());
      formData.append('detectSpeakers', 'true');

      const response = await fetch('/api/external-audio/process', {
        method: 'POST',
        body: formData
      });

      const data = await response.json();
      
      if (data.success && data.data.status === 'success') {
        const result = data.data;
        setCurrentText(result.transcription.text);
        setTranslatedText(result.translation.text);
        setAudioQuality(result.audio.quality);
        
        const endTime = Date.now();
        setProcessingTime(endTime - startTime);

        // Êõ¥Êñ∞ËØ¥ËØù‰∫∫‰ø°ÊÅØ
        if (result.transcription.speakers) {
          setDetectedSpeakers(result.transcription.speakers);
        }

        // Ê∑ªÂä†Âà∞ÂéÜÂè≤ËÆ∞ÂΩï
        const historyItem = {
          id: Date.now(),
          timestamp: new Date().toISOString(),
          original: result.transcription.text,
          translated: result.translation.text,
          sourceLanguage: result.transcription.language,
          targetLanguage: result.translation.language,
          confidence: result.translation.confidence,
          processingTime: endTime - startTime,
          audioQuality: result.audio.quality,
          speakers: result.transcription.speakers || [],
          context: result.translation.context || 'general'
        };

        setTranslationHistory(prev => [historyItem, ...prev.slice(0, 19)]); // ‰øùÁïôÊúÄËøë20Êù°
        setTranslationCount(prev => prev + 1);

        // ÂõûË∞ÉÈÄöÁü•
        onTranslationUpdate(historyItem);

      } else if (data.data && data.data.status === 'no_voice_detected') {
        // Ê≤°ÊúâÊ£ÄÊµãÂà∞ËØ≠Èü≥ÔºåËøôÊòØÊ≠£Â∏∏ÊÉÖÂÜµ
        console.log('Êú™Ê£ÄÊµãÂà∞ËØ≠Èü≥ÂÜÖÂÆπ');
      }

    } catch (error) {
      console.error('Â§ÑÁêÜÂ§ñÈÉ®Èü≥È¢ëÂ§±Ë¥•:', error);
    }
  };

  // ÊâãÂä®ÂΩïÂà∂
  const startManualRecording = async () => {
    if (!mediaStreamRef.current) {
      await startListening();
    }

    if (mediaRecorderRef.current) {
      audioChunksRef.current = [];
      mediaRecorderRef.current.start();
    }
  };

  const stopManualRecording = () => {
    if (mediaRecorderRef.current && mediaRecorderRef.current.state === 'recording') {
      mediaRecorderRef.current.stop();
    }
  };

  // ÂàáÊç¢ÁõëÂê¨Ê®°Âºè
  const toggleListening = async () => {
    if (isListening) {
      await stopListening();
    } else {
      await startListening();
    }
  };

  // Êõ¥Êñ∞ËÆæÁΩÆ
  const updateSettings = async (newSettings) => {
    if (!sessionRef.current) return;

    try {
      const response = await fetch(`/api/external-audio/listener/${sessionRef.current}/settings`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(newSettings)
      });

      const data = await response.json();
      if (!data.success) {
        console.error('Êõ¥Êñ∞ËÆæÁΩÆÂ§±Ë¥•:', data.error);
      }

    } catch (error) {
      console.error('Êõ¥Êñ∞ËÆæÁΩÆÂ§±Ë¥•:', error);
    }
  };

  // Ê†ºÂºèÂåñÊó∂Èó¥
  const formatDuration = (seconds) => {
    const mins = Math.floor(seconds / 60);
    const secs = seconds % 60;
    return `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
  };

  // Ëé∑ÂèñÈü≥È¢ëË¥®ÈáèÈ¢úËâ≤
  const getQualityColor = (quality) => {
    switch (quality) {
      case 'excellent': return 'text-green-400';
      case 'good': return 'text-blue-400';
      case 'fair': return 'text-yellow-400';
      case 'poor': return 'text-red-400';
      default: return 'text-gray-400';
    }
  };

  return (
    <div className={`bg-gray-900/95 backdrop-blur-sm rounded-2xl border border-gray-700 ${className}`}>
      {/* Ê†áÈ¢òÊ†è */}
      <div className="p-6 border-b border-gray-700">
        <div className="flex items-center justify-between">
          <div className="flex items-center gap-3">
            <div className="p-2 bg-gradient-to-r from-green-500 to-teal-500 rounded-lg">
              <Ear className="w-5 h-5 text-white" />
            </div>
            <div>
              <h3 className="text-white font-semibold">Â§ñÈÉ®Èü≥È¢ëÂÆûÊó∂ÁøªËØë</h3>
              <p className="text-gray-400 text-sm">
                ÁõëÂê¨Âë®Âõ¥ÁéØÂ¢ÉÈü≥È¢ëÂπ∂ÂÆûÊó∂ÁøªËØë
              </p>
            </div>
          </div>
          
          <div className="flex items-center gap-2">
            {isListening && (
              <Badge variant="default" className="bg-green-500">
                <Activity className="w-3 h-3 mr-1" />
                ÁõëÂê¨‰∏≠
              </Badge>
            )}
            <Button
              variant="ghost"
              size="sm"
              onClick={() => setShowAdvanced(!showAdvanced)}
            >
              <Settings className="w-4 h-4" />
            </Button>
          </div>
        </div>
      </div>

      <div className="p-6">
        <Tabs defaultValue="main" className="w-full">
          <TabsList className="grid w-full grid-cols-3">
            <TabsTrigger value="main">‰∏ªÊéßÂà∂</TabsTrigger>
            <TabsTrigger value="settings">ËÆæÁΩÆ</TabsTrigger>
            <TabsTrigger value="stats">ÁªüËÆ°</TabsTrigger>
          </TabsList>

          <TabsContent value="main" className="space-y-6">
            {/* ËØ≠Ë®ÄËÆæÁΩÆ */}
            <div className="grid grid-cols-2 gap-4">
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">Ê∫êËØ≠Ë®Ä</label>
                <select
                  value={sourceLanguage}
                  onChange={(e) => {
                    setSourceLanguage(e.target.value);
                    if (isListening) {
                      updateSettings({ sourceLanguage: e.target.value });
                    }
                  }}
                  className="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white"
                  disabled={isListening}
                >
                  {supportedLanguages.map(lang => (
                    <option key={lang.code} value={lang.code}>
                      {lang.flag} {lang.name}
                    </option>
                  ))}
                </select>
              </div>
              
              <div>
                <label className="block text-sm font-medium text-gray-300 mb-2">ÁõÆÊ†áËØ≠Ë®Ä</label>
                <select
                  value={targetLanguage}
                  onChange={(e) => {
                    setTargetLanguage(e.target.value);
                    if (isListening) {
                      updateSettings({ targetLanguage: e.target.value });
                    }
                  }}
                  className="w-full bg-gray-800 border border-gray-600 rounded-lg px-3 py-2 text-white"
                >
                  {supportedLanguages.filter(lang => lang.code !== 'auto').map(lang => (
                    <option key={lang.code} value={lang.code}>
                      {lang.flag} {lang.name}
                    </option>
                  ))}
                </select>
              </div>
            </div>

            {/* Èü≥È¢ëÁ∫ßÂà´ÂíåËØ≠Èü≥Ê¥ªÂä®ÊåáÁ§∫Âô® */}
            {isListening && (
              <div className="space-y-4">
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-gray-300">Èü≥È¢ëÁ∫ßÂà´</span>
                    <div className="flex items-center gap-2">
                      <Badge variant={voiceActivity ? 'default' : 'secondary'}>
                        {voiceActivity ? 'Ê£ÄÊµãÂà∞ËØ≠Èü≥' : 'ÈùôÈü≥'}
                      </Badge>
                      <Badge variant="outline" className={getQualityColor(audioQuality)}>
                        {audioQuality}
                      </Badge>
                    </div>
                  </div>
                  <div className="flex items-center gap-2">
                    <Volume2 className="w-4 h-4 text-gray-400" />
                    <div className="flex-1 bg-gray-700 rounded-full h-3">
                      <div 
                        className={`h-3 rounded-full transition-all duration-100 ${
                          voiceActivity 
                            ? 'bg-gradient-to-r from-green-500 to-blue-500' 
                            : 'bg-gradient-to-r from-gray-500 to-gray-600'
                        }`}
                        style={{ width: `${audioLevel * 100}%` }}
                      />
                    </div>
                    <span className="text-xs text-gray-400 w-8">
                      {Math.round(audioLevel * 100)}%
                    </span>
                  </div>
                </div>

                {/* ËÉåÊôØÂô™Èü≥Á∫ßÂà´ */}
                <div>
                  <div className="flex items-center justify-between mb-2">
                    <span className="text-sm text-gray-300">ËÉåÊôØÂô™Èü≥</span>
                    <span className="text-xs text-gray-500">
                      {Math.round(backgroundNoise * 100)}%
                    </span>
                  </div>
                  <div className="flex items-center gap-2">
                    <Waves className="w-4 h-4 text-gray-400" />
                    <div className="flex-1 bg-gray-700 rounded-full h-2">
                      <div 
                        className="bg-gradient-to-r from-orange-500 to-red-500 h-2 rounded-full transition-all duration-300"
                        style={{ width: `${backgroundNoise * 100}%` }}
                      />
                    </div>
                  </div>
                </div>
              </div>
            )}

            {/* ‰∏ªÊéßÂà∂ÊåâÈíÆ */}
            <div className="flex justify-center">
              <Button
                onClick={toggleListening}
                size="lg"
                className={`w-20 h-20 rounded-full ${
                  isListening
                    ? 'bg-red-500 hover:bg-red-600'
                    : 'bg-gradient-to-r from-green-500 to-teal-500 hover:from-green-600 hover:to-teal-600'
                }`}
                disabled={isProcessing}
              >
                {isProcessing ? (
                  <Activity className="w-8 h-8 animate-spin" />
                ) : isListening ? (
                  <Square className="w-8 h-8" />
                ) : (
                  <Ear className="w-8 h-8" />
                )}
              </Button>
            </div>

            {/* Áä∂ÊÄÅ‰ø°ÊÅØ */}
            {isListening && (
              <div className="grid grid-cols-3 gap-4 text-center">
                <div className="bg-gray-800 rounded-lg p-3">
                  <Clock className="w-5 h-5 mx-auto mb-1 text-blue-400" />
                  <div className="text-sm text-gray-300">ÁõëÂê¨Êó∂Èïø</div>
                  <div className="text-lg font-semibold text-white">
                    {formatDuration(listeningDuration)}
                  </div>
                </div>
                
                <div className="bg-gray-800 rounded-lg p-3">
                  <Target className="w-5 h-5 mx-auto mb-1 text-green-400" />
                  <div className="text-sm text-gray-300">ÁøªËØëÊ¨°Êï∞</div>
                  <div className="text-lg font-semibold text-white">
                    {translationCount}
                  </div>
                </div>
                
                <div className="bg-gray-800 rounded-lg p-3">
                  <Users className="w-5 h-5 mx-auto mb-1 text-purple-400" />
                  <div className="text-sm text-gray-300">Ê£ÄÊµãËØ¥ËØù‰∫∫</div>
                  <div className="text-lg font-semibold text-white">
                    {detectedSpeakers.length}
                  </div>
                </div>
              </div>
            )}

            {/* ÁøªËØëÁªìÊûú */}
            {(currentText || translatedText) && (
              <div className="space-y-4">
                {currentText && (
                  <div className="bg-gray-800 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs text-gray-400 uppercase">ÂéüÊñá</span>
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-gray-500">{sourceLanguage}</span>
                        {detectedSpeakers.length > 0 && (
                          <Badge variant="outline" className="text-xs">
                            <Users className="w-3 h-3 mr-1" />
                            {detectedSpeakers.length}‰∫∫
                          </Badge>
                        )}
                      </div>
                    </div>
                    <p className="text-white">{currentText}</p>
                  </div>
                )}

                {translatedText && (
                  <div className="bg-gradient-to-r from-green-900/50 to-teal-900/50 rounded-lg p-4">
                    <div className="flex items-center justify-between mb-2">
                      <span className="text-xs text-gray-400 uppercase">ËØëÊñá</span>
                      <div className="flex items-center gap-2">
                        <span className="text-xs text-gray-500">{targetLanguage}</span>
                        {processingTime > 0 && (
                          <Badge variant="outline" className="text-xs">
                            <Clock className="w-3 h-3 mr-1" />
                            {processingTime}ms
                          </Badge>
                        )}
                      </div>
                    </div>
                    <p className="text-white">{translatedText}</p>
                  </div>
                )}
              </div>
            )}
          </TabsContent>

          <TabsContent value="settings" className="space-y-6">
            {/* Âü∫Á°ÄËÆæÁΩÆ */}
            <div className="space-y-4">
              <div>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-gray-300">ÁÅµÊïèÂ∫¶</span>
                  <span className="text-xs text-gray-500">{Math.round(sensitivity * 100)}%</span>
                </div>
                <Slider
                  value={[sensitivity]}
                  onValueChange={(value) => {
                    setSensitivity(value[0]);
                    if (isListening) {
                      updateSettings({ sensitivity: value[0] });
                    }
                  }}
                  max={1}
                  step={0.1}
                  className="w-full"
                />
              </div>

              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Filter className="w-4 h-4 text-gray-400" />
                  <span className="text-sm text-gray-300">Âô™Èü≥ÈôçÂô™</span>
                </div>
                <Switch
                  checked={noiseReduction}
                  onCheckedChange={(checked) => {
                    setNoiseReduction(checked);
                    if (isListening) {
                      updateSettings({ noiseReduction: checked });
                    }
                  }}
                  disabled={isListening}
                />
              </div>

              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Zap className="w-4 h-4 text-gray-400" />
                  <span className="text-sm text-gray-300">Ëá™Âä®ÁøªËØë</span>
                </div>
                <Switch
                  checked={autoTranslate}
                  onCheckedChange={(checked) => {
                    setAutoTranslate(checked);
                    if (isListening) {
                      updateSettings({ autoTranslate: checked });
                    }
                  }}
                />
              </div>

              <div className="flex items-center justify-between">
                <div className="flex items-center gap-2">
                  <Radio className="w-4 h-4 text-gray-400" />
                  <span className="text-sm text-gray-300">ËøûÁª≠Ê®°Âºè</span>
                </div>
                <Switch
                  checked={continuousMode}
                  onCheckedChange={setContinuousMode}
                  disabled={isListening}
                />
              </div>

              <div>
                <div className="flex items-center justify-between mb-2">
                  <span className="text-sm text-gray-300">Êí≠ÊîæÈü≥Èáè</span>
                  <span className="text-xs text-gray-500">{Math.round(volume * 100)}%</span>
                </div>
                <Slider
                  value={[volume]}
                  onValueChange={(value) => setVolume(value[0])}
                  max={1}
                  step={0.1}
                  className="w-full"
                />
              </div>
            </div>
          </TabsContent>

          <TabsContent value="stats" className="space-y-6">
            {/* ÁªüËÆ°‰ø°ÊÅØ */}
            <div className="grid grid-cols-2 gap-4">
              <Card className="bg-gray-800 border-gray-700">
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm text-gray-300">ÊÄªÁøªËØëÊ¨°Êï∞</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold text-white">{translationCount}</div>
                </CardContent>
              </Card>

              <Card className="bg-gray-800 border-gray-700">
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm text-gray-300">Âπ≥ÂùáÂ§ÑÁêÜÊó∂Èó¥</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold text-white">
                    {translationHistory.length > 0 
                      ? Math.round(translationHistory.reduce((sum, item) => sum + item.processingTime, 0) / translationHistory.length)
                      : 0}ms
                  </div>
                </CardContent>
              </Card>

              <Card className="bg-gray-800 border-gray-700">
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm text-gray-300">Èü≥È¢ëË¥®ÈáèÂàÜÂ∏É</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="space-y-1">
                    {['excellent', 'good', 'fair', 'poor'].map(quality => {
                      const count = translationHistory.filter(item => item.audioQuality === quality).length;
                      const percentage = translationHistory.length > 0 ? (count / translationHistory.length) * 100 : 0;
                      return (
                        <div key={quality} className="flex items-center justify-between text-xs">
                          <span className={`capitalize ${getQualityColor(quality)}`}>{quality}</span>
                          <span className="text-gray-400">{Math.round(percentage)}%</span>
                        </div>
                      );
                    })}
                  </div>
                </CardContent>
              </Card>

              <Card className="bg-gray-800 border-gray-700">
                <CardHeader className="pb-2">
                  <CardTitle className="text-sm text-gray-300">Ê£ÄÊµãÂà∞ÁöÑËØ¥ËØù‰∫∫</CardTitle>
                </CardHeader>
                <CardContent>
                  <div className="text-2xl font-bold text-white">{detectedSpeakers.length}</div>
                  {detectedSpeakers.length > 0 && (
                    <div className="mt-2 space-y-1">
                      {detectedSpeakers.slice(0, 3).map((speaker, index) => (
                        <div key={speaker.id || index} className="text-xs text-gray-400">
                          ËØ¥ËØù‰∫∫ {index + 1}: {speaker.gender || 'Êú™Áü•'} ({Math.round(speaker.confidence * 100)}%)
                        </div>
                      ))}
                    </div>
                  )}
                </CardContent>
              </Card>
            </div>

            {/* ÁøªËØëÂéÜÂè≤ */}
            {translationHistory.length > 0 && (
              <div>
                <h4 className="text-sm font-medium text-gray-300 mb-3">ÊúÄËøëÁøªËØëÂéÜÂè≤</h4>
                <div className="space-y-2 max-h-60 overflow-y-auto">
                  {translationHistory.slice(0, 5).map(item => (
                    <div key={item.id} className="bg-gray-800 rounded-lg p-3">
                      <div className="flex items-center justify-between mb-2">
                        <span className="text-xs text-gray-400">
                          {new Date(item.timestamp).toLocaleTimeString()}
                        </span>
                        <div className="flex items-center gap-2">
                          <Badge variant="outline" className={`text-xs ${getQualityColor(item.audioQuality)}`}>
                            {item.audioQuality}
                          </Badge>
                          <Badge variant="outline" className="text-xs">
                            {item.processingTime}ms
                          </Badge>
                        </div>
                      </div>
                      <div className="text-sm text-white mb-1">{item.original}</div>
                      <div className="text-sm text-green-300">{item.translated}</div>
                      {item.speakers && item.speakers.length > 0 && (
                        <div className="text-xs text-gray-500 mt-1">
                          ËØ¥ËØù‰∫∫: {item.speakers.length}‰∫∫
                        </div>
                      )}
                    </div>
                  ))}
                </div>
              </div>
            )}
          </TabsContent>
        </Tabs>
      </div>
    </div>
  );
};

export default ExternalAudioTranslator;

